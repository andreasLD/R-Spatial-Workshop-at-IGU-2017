
###############################
### Part II - Intro to 'sf' ###
###############################

## ------------------------------------------------------------------------
library(sf)

## ------------------------------------------------------------------------
pnt1 = st_point(c(34.812831, 31.260284))

## ------------------------------------------------------------------------
pnt1

## ------------------------------------------------------------------------
class(pnt1)

## ------------------------------------------------------------------------
pnt2 = st_point(c(34.798443, 31.243288))

## ------------------------------------------------------------------------
geom = st_sfc(pnt1, pnt2, crs = 4326)

## ------------------------------------------------------------------------
geom

## ------------------------------------------------------------------------
dat = data.frame(
  name = c("Beer-Sheva North", "Beer-Sheva Center")
)

## ------------------------------------------------------------------------
dat

## ------------------------------------------------------------------------
pnt = st_sf(dat, geom)

## ------------------------------------------------------------------------
pnt

## ------------------------------------------------------------------------
st_geometry(pnt)

## ------------------------------------------------------------------------
st_set_geometry(pnt, NULL)

## ------------------------------------------------------------------------
st_coordinates(pnt)

## ------------------------------------------------------------------------
library(mapview)
# mapview(pnt)

################################
### Part III - Advanced 'sf' ###
################################

## ------------------------------------------------------------------------
# View(st_drivers(what = "vector"))

## ---- eval=FALSE---------------------------------------------------------
setwd("~/Dropbox/Presentations/p_2017_08_R_workshop/michael/data/")

## ---- message=FALSE, include=FALSE---------------------------------------
states = st_read(
  dsn = "cb_2015_us_state_5m.shp", 
  stringsAsFactors = FALSE
  )
tracks = st_read(
  dsn = "hurmjrl020.shp", 
  stringsAsFactors = FALSE
  )

## ------------------------------------------------------------------------
dim(states)

## ------------------------------------------------------------------------
plot(states, key.pos = NULL)

## ------------------------------------------------------------------------
dim(tracks)

## ------------------------------------------------------------------------
plot(tracks)

## ------------------------------------------------------------------------
plot(st_geometry(states), border = "grey")

## ------------------------------------------------------------------------
plot(st_geometry(states), border = "grey")
plot(st_geometry(tracks), col = "red", add = TRUE)

## ------------------------------------------------------------------------
# mapview(tracks, zcol = "wind_mph", legend = TRUE)

## ------------------------------------------------------------------------
nm = states[states$state == "New Mexico", ]

## ------------------------------------------------------------------------
plot(st_geometry(states))
plot(st_geometry(nm), add = TRUE, border = NA, col = "red")

## ------------------------------------------------------------------------
tracks = tracks[tracks$year > 1949, ]

## ------------------------------------------------------------------------
states = st_transform(states, 2163)
tracks = st_transform(tracks, 2163)

## ------------------------------------------------------------------------
plot(states, key.pos = NULL)

## ------------------------------------------------------------------------
area = st_area(states)
area[1:3]

## ------------------------------------------------------------------------
class(area)

## ------------------------------------------------------------------------
library(units)
states$area_km2 = set_units(area, km^2)
states$area_km2[1:3]

## ------------------------------------------------------------------------
states$area_km2 = as.numeric(states$area_km2)
states$area_km2[1:3]

## ------------------------------------------------------------------------
opar = par()
plot(states[, "area_km2"])
par(opar) 

## ------------------------------------------------------------------------
int = st_intersects(states, states, sparse = FALSE)

## ------------------------------------------------------------------------
int[1:3, 1:3]

## ------------------------------------------------------------------------
states_ctr = st_centroid(states)

## ------------------------------------------------------------------------
plot(st_geometry(states))
plot(st_geometry(states_ctr), col = "red", pch = 3, add = TRUE)

## ------------------------------------------------------------------------
tracks_int = st_intersection(tracks, states)

## ------------------------------------------------------------------------
plot(st_geometry(states), border = "lightgrey")
plot(tracks_int[, "state"], lwd = 3, add = TRUE, key.pos = NULL)

## ------------------------------------------------------------------------
class(tracks_int$geometry)

## ------------------------------------------------------------------------
tracks_int = st_cast(tracks_int, "MULTILINESTRING")

## ------------------------------------------------------------------------
class(tracks_int$geometry)

## ------------------------------------------------------------------------
tracks_int$length = st_length(tracks_int)
tracks_int$length = set_units(tracks_int$length, km) 
tracks_int$length = as.numeric(tracks_int$length)

## ------------------------------------------------------------------------
track_lengths = aggregate(
  st_set_geometry(tracks_int[, c("length")], NULL),
  st_set_geometry(tracks_int[, c("state")], NULL),
  FUN = sum
)

## ------------------------------------------------------------------------
head(track_lengths)

## ------------------------------------------------------------------------
states = merge(
  states, 
  track_lengths, 
  by = "state", 
  all.x = TRUE
  )

## ------------------------------------------------------------------------
head(states)

## ------------------------------------------------------------------------
states$track_density = states$length / states$area_km2

## ------------------------------------------------------------------------
plot(states)

###########
### End ###
###########



































